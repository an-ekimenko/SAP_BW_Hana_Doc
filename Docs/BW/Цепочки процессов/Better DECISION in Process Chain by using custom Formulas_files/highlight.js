var ns={high:"http://schemaapp.com/ontology/highlight#",schema:"http://schema.org/",rdf:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",gist:"http://ontologies.semanticarts.com/gist#"};var applicableTemplates=[];var config=null;var resourcesReady=false;var templatesLoaded=false;var schemaServer="https://cdn.schemaapp.com";var schemaCDN="https://data.schemaapp.com/";var LOCAL_STORAGE_KEY=location.host+"-schemaapp";var LOCAL_STORAGE_DATE_KEY=LOCAL_STORAGE_KEY+"-Date";var templateDict={};var TEXT_NODE=3;var CAPTURE_PAGE=false;var API_KEY_FIELD="X-API-KEY";var ANALYTICS_ENDPOINT="https://0yl6pcjbij.execute-api.us-east-1.amazonaws.com/prod";var ANALYTICS_KEY="BiQcqdttWn7eunp8jvxM5oZl3DIx08J42LtTmaaj";var externalResources=[];function applyContentFilter(a,c){var e=a;var b=[];if(c){var d=c.split('");');d.splice(d.length-1,1);d.forEach(function(g){var f={optionSelected:null,filterText:""};var h=g.split('("');f.optionSelected=h[0];if(h[1]){f.filterText=h[1]}b.push(f)})}b.forEach(function(h){var l=e.toLowerCase();var k=h.filterText.toLowerCase();switch(h.optionSelected){case"BEFORE":if(h.filterText){var f=l.indexOf(k);if(f>=0){e=e.slice(0,f)}else{e=""}}break;case"AFTER":if(h.filterText){var f=l.indexOf(k);if(f>=0){e=e.slice(f+k.length)}else{e=""}}break;case"OMIT":var j=new RegExp(h.filterText,"mi");e=e.replace(j,"");break;case"NUMBER":var i=/(\+|-)*((\d+[.]\d*)|(\d*[.]\d+)|\d+)/mi;var j=new RegExp(i);var g=j.exec(e);g?e=g[0]:e=null;break;case"NONNUMBER":e=e.replace(/\d+/gm,"");break}});return e?e:a}function insertInto(e,d,a){if(d===null||d.length===0){return}if(!e.includes("~")){if(a[e]!==undefined&&a[e].constructor===Array){a[e].concat(d)}else{a[e]=d}return}var c=e.split("~");var g=a;for(var b=1;b<=c.length;b++){var f=c[b-1];if(b%2===0){if(g.length==0){g.push({"@type":f})}g=g[0]}else{if(b===c.length){if(g[f]!==undefined&&g[f].constructor==Array){g[f].concat(d)}else{g[f]=d}}else{if(g[f]===undefined){g[f]=[]}}g=g[f]}}}function hasLocalStorage(a){try{var c=window[a];item="Test";c.setItem(item,item);c.removeItem(item);return true}catch(b){console.log("Storage not available "+b.code+" "+b.name)}return false}function injectJSON(b){if(b!==""){var a=document.createElement("script");a.type="application/ld+json";a.innerHTML=b;document.getElementsByTagName("head")[0].appendChild(a)}}function timeOk(b){var a=24*60*60;var c=new Date().getTime()-parseInt(b);return c<a}function persistToLocalStorage(a){if(hasLocalStorage("localStorage")){var b=window.localStorage;b.setItem(LOCAL_STORAGE_KEY,JSON.stringify(a));b.setItem(LOCAL_STORAGE_DATE_KEY,new Date().getTime().toString())}}function schemaAppgetAccountId(){var b=applicableTemplates[0].replace("http://schemaapp.com/db/","");var a=b.split("/");if(a[1]!==undefined&&a[1].match(/Template[0-9]+/)===null){var c=a[0]+"/"+a[1]}else{var c=a[0]}return c}function getDate(){var b=new Date();var c=b.getFullYear();var d=b.getMonth()+1;var a=b.getDate();if(d.toString().length==1){d="0"+d}if(a.toString().length==1){a="0"+a}return c+"-"+d+"-"+a}function countPageForAnalytics(){var a=window.location.origin+window.location.pathname;var m=window.location.protocol+window.location.hostname;var n=m.replace(/\./g,"").replace(/:/g,"");for(var g=0;g<applicableTemplates.length;g++){var b=applicableTemplates[g].replace("http://schemaapp.com/db/","");var h=b.split("/");var c=[];for(var d=0;d<h.length;d++){var f=h[d];if(f==n||f.match(/Template[0-9]+/)!==null){break}c.push(f)}if(c[1]!==undefined){var k=c[0]+"/"+c[1]}else{var k=c[0]}if(window.location.origin.includes("jbhunt")){var a=window.location.href}var e={AccountId:c[0],SubAccount:c[1]!==undefined?c[1]:"",DateSeen:getDate(),Source:"HighlightJS:"+applicableTemplates[g],Domain:window.location.origin,URL:a};var l=new XMLHttpRequest();l.open("POST",ANALYTICS_ENDPOINT,true);l.setRequestHeader(API_KEY_FIELD,ANALYTICS_KEY);l.setRequestHeader("content-type","application/json");l.send(JSON.stringify(e))}}function schemaAppLoadResources(){var c=window.location.protocol+"//"+window.location.host;var b=btoa(unescape(c)).replace(/=/g,"");var a=schemaServer+"/highlighter/prod/"+b;var d=new XMLHttpRequest();d.onreadystatechange=function(){if(this.readyState!==4||this.status!==200){return}config=JSON.parse(d.responseText);processConfig();persistToLocalStorage(config)};d.open("GET",a,true);d.send()}function processConfig(){var b=getEntityByType(config,"HighlightTemplate");var a=[location.protocol,"//",location.host,location.pathname].join("");b.forEach(function(p){var d=true;var o=config[p];if(o[ns.high+"pattern"]===undefined){return}for(var k=0;k<o[ns.high+"pattern"].length;k++){var q=o[ns.high+"pattern"][k];var m=config[q.value];var c=m[ns.gist+"categorizedBy"];var h=m[ns.gist+"hasMember"];for(var g=0;g<h.length;g++){var n=c[0];var f=n.value.replace(ns.high,"");var e=m[ns.gist+"hasMember"][g];var l=e.value;if(f==="GlobCollection"){if(globChecker(a,l)){d=false}}else{if(f==="XPathCollection"){if(document.evaluate(l,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue){d=false}}else{if(l.toLowerCase()==a){d=false}}}}}if(!d){console.log("Pushing Template "+p);applicableTemplates.push(p)}});resourcesReady=true;loadTemplates()}function processHighlights(b,a,c){b.forEach(function(f){var e=getObjects(config,f,ns.rdf+"type");var k=config[f];if(c!==undefined){k[ns.high+"xPath"][0]["value"]=c+k[ns.high+"xPath"][0]["value"]}var d=tagFactory(e[0],k);var g=d[0];var j=g[ns.high+"propertyPath"][0].value;var i=Tag.extract(d);insertInto(j,i,a)});return a}function processListTagHighlights(l,f,o,c){var e=o[ns.high+"xPath"][0]["value"];var d=o[ns.high+"propertyPath"][0]["value"];var k=[];if(e.slice(-1)=="]"){e=e.split("/");e.pop();e.push("*");e=e.join("/")}var g=o[ns.high+"propertyPath"][0]["value"].split("~");var m=g.pop();var n=g.join("~");var a=document.evaluate(e,document,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);for(var j=0;j<a.snapshotLength;j++){var h=a.snapshotItem(j);var b={"@type":m,"@id":window.location.href+"#"+m.replace("http://schema.org/","")+"_"+c};l.forEach(function(r){var p=getObjects(config,r,ns.rdf+"type");var u=config[r];var q=null;if(u[ns.rdf+"type"][0]["value"]===ns.high+"TagXPath"){if(!u[ns.high+"xPath"]){q="text()";u[ns.high+"xPath"]=[{value:q}]}else{q=u[ns.high+"xPath"][0]["value"]}u[ns.high+"xPath"][0]["value"]=q.indexOf("/")==0?q.slice(1):q}var i=tagFactory(p[0],u);var s=i[0];var t=s[ns.high+"propertyPath"][0].value;insertInto(t,Tag.extract(i,h),b)});c++;k.push(b)}insertInto(n,k,f);return{resource:f,objectCount:a.snapshotLength}}function loadTemplates(){if(!resourcesReady||templatesLoaded){return false}templatesLoaded=true;applicableTemplates.forEach(function(d){var b=getObjects(config,d,ns.gist+"categorizedBy");var a={"@context":"http://schema.org/","@type":b[0],"@id":window.location.href+"#"+b[0].replace("http://schema.org/",""),url:window.location.href};var c=[];var g=[];var e=getObjects(config,d,ns.high+"hasHighlight");e.forEach(function(j){var i=getObjects(config,j,ns.rdf+"type");if(i==ns.high+"TagList"){g.push(j)}else{c.push(j)}});processHighlights(c,a);var f=1;g.forEach(function(l){var i=config[l];var j=getObjects(config,l,ns.high+"hasTemplate");var k=config[j[0]];var m=getObjects(config,j,ns.high+"hasHighlight");res=processListTagHighlights(m,a,i,f);a=res.resource;f+=res.objectCount});injectJSON(JSON.stringify(a))});countPageForAnalytics()}function getObjects(b,c,a){var e=[];for(var d in b[c]){if(d===a){for(var f in b[c][d]){if(b[c][d][f].type==="uri"){e.push(b[c][d][f].value)}else{if(b[c][d][f].type==="literal"){e.push(b[c][d][f].value)}}}}}return e}function getEntityByType(a,c){var e=[];for(var b in a){for(var d in a[b]){if(d===ns.rdf+"type"){if(a[b][d][0].value===(ns.high+c)){e.push(b)}}}}return e}function tagFactory(b,a){if(b===(ns.high+"TagXPath")||b===(ns.high+"TagXPathDefined")){return Tag.construct(a,Tag.tagTypes.TagXPath)}else{if(b===(ns.high+"TagDefined")){return Tag.construct(a,Tag.tagTypes.TagDefined)}else{if(b===(ns.high+"TagStoredResource")){return Tag.construct(a,Tag.tagTypes.TagStoredResource)}else{if(b===(ns.high+"TagYouTube")){return Tag.construct(a,Tag.tagTypes.TagYouTube)}}}}throw new TypeError("Tag Factory unable to create class "+b)}var Tag={tagTypes:Object.freeze({TagXPath:1,TagDefined:2,TagStoredResource:3,TagYouTube:4}),construct:function(a,b){return[a,[],b]},extract:function(b,a){var c=b[2];if(a===undefined){a=document}switch(c){case Tag.tagTypes.TagXPath:return Tag.xpathExtract(b,a);break;case Tag.tagTypes.TagDefined:return Tag.tagDefined(b);break;case Tag.tagTypes.TagStoredResource:return Tag.storedResource(b);break;case Tag.tagTypes.TagYouTube:return Tag.videoResource(b);break}},getContentFromElement:function(e){if(e.nodeType===TEXT_NODE){return e.wholeText}var b=e.localName.toLowerCase();var c=new Set(["img","video","audio","source","embed"]);var d=new Set(["a","area"]);var i=new Set(["meta"]);if(c.has(b)){if(e.hasAttribute("src")){var a=e.getAttribute("src");if(!a.startsWith("http")){a=window.location.protocol+"//"+window.location.host+a}return a}else{return Tag.getContentFromElement(e.getElementsByTagName("source")[0])}}else{if(d.has(b)){var h=e.getAttribute("href");return h}else{if(i.has(b)){var j=e.getAttribute("content");return j}}}var f=e.cloneNode(true);removeScripts(f);var g=f.textContent;return g},tagDefined:function(b){var a=b[0];return a[ns.high+"value"][0].value},videoResource:function(c,b){var i={"@id":a};var d=c[0];var g=d[ns.high+"xPath"][0].value;var f=d[ns.high+"propertyPath"][0].value;var e=document.evaluate(g,b,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null).snapshotItem(0);if(!e){return null}var a=e.src.split("/").pop();var h=new XMLHttpRequest();h.onreadystatechange=function(){if(this.readyState!==4||this.status!==200){return}var j=JSON.parse(xhr.responseText);j["@id"]=a;injectJSON(JSON.stringify(j))};h.open("GET",schemaServer+"/schemaorg/video.json?ids="+a,true);h.send();return i},xpathExtract:function(d,c){var e=d[0];var j,h,g;var b="";h=e[ns.high+"xPath"][0].value;if(e[ns.high+"filter"]!==undefined){b=e[ns.high+"filter"][0].value}g=e[ns.high+"propertyPath"][0].value;if(h.includes("preceeding-sibling")||h.includes("following-sibling")){var a=document.evaluate(h,c,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE);var j="";for(var i=0;i<a.snapshotLength;i++){var f=a.snapshotItem(i);j+=Tag.getContentFromElement(f)+"\n"}j=applyContentFilter(j,b)}else{var f=document.evaluate(h,c,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE).snapshotItem(0);if(!f){return null}j=Tag.getContentFromElement(f);j=applyContentFilter(j,b)}if(j!=null){j=j.replace(/\s\s+/g," ");return j}return null},storedResource:function(a){var b=a[0];var e=false;var i=b[ns.high+"value"][0].value;var f=btoa(unescape(i)).replace(/=/g,"");var h=schemaAppgetAccountId();var g=schemaCDN+h+"/"+f;if(i.includes("www.")){var c=i.replace("www.","")}else{var c=i.replace("://","://www.")}var d=btoa(unescape(c)).replace(/=/g,"");var j=new XMLHttpRequest();if(externalResources.includes(i)){return{"@id":i}}externalResources.push(i);j.onreadystatechange=function(){if(this.readyState===4&&this.status===200){injectJSON(j.responseText);if(j.responseText===""&&!e){j.open("GET",schemaCDN+h+d,true);j.send();e=true}}else{if(this.readyState===4&&this.status!=200){if(!e){j.open("GET",schemaCDN+h+d,true);j.send()}e=true}}};j.open("GET",g,true);j.send();return{"@id":i}}};function removeScripts(b){var c=[];if(b.children){for(var a=0;a<b.children.length;a++){var d=b.children[a];removeScripts(d);if(d.localName.toLowerCase()==="script"){c.push(d)}}}for(var a=0;a<c.length;a++){b.removeChild(c[a])}}function globChecker(g,f){if(f.charAt(0)!=="/"){f="/"+f}g=g.replace(new RegExp(".+://"),"");var b=g.split("/");var c=f.split("/");var d=1;for(d=1;d<b.length;d++){var a=b[d];if(c.length>d){var e=c[d];if(e==="*"){continue}else{if(e==="**"){return true}}if(a!==e){return false}}else{return false}}return(d>=c.length)}if(hasLocalStorage("localStorage")){var storage=window.localStorage;var storedTemplates=storage.getItem(LOCAL_STORAGE_KEY);var time=storage.getItem(LOCAL_STORAGE_DATE_KEY);if(storedTemplates!==null&&timeOk(time)){config=JSON.parse(storedTemplates);templatesLoaded=true;processConfig()}else{schemaAppLoadResources()}window.addEventListener("load",function(a){loadTemplates()})}else{schemaAppLoadResources();window.addEventListener("load",function(a){loadTemplates()})};